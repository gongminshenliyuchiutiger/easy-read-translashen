<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>易讀轉譯系統 | Easy Read Translashen</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC (更適合閱讀) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }

        /* 吉祥物特效動畫 */
        @keyframes neon-jitter {
            0% { transform: translate(1px, 1px) rotate(0deg); filter: drop-shadow(0 0 5px #ff00de); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); filter: drop-shadow(0 0 10px #00ffff); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); filter: drop-shadow(0 0 5px #ff00de); }
            90% { transform: translate(1px, 2px) rotate(0deg); filter: drop-shadow(0 0 25px #ff0000); }
            100% { transform: translate(1px, -2px) rotate(-1deg); filter: drop-shadow(0 0 5px #ff00de); }
        }

        #mascot-container {
            position: fixed;
            z-index: 9999;
            cursor: grab;
            user-select: none;
            touch-action: none;
            bottom: 20px;
            left: 20px;
            width: 100px;
            transition: transform 0.1s;
        }
        #mascot-container:active { cursor: grabbing; transform: scale(0.95); }
        #mascot-img {
            width: 100%; height: auto;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            transition: filter 0.3s;
        }
        #mascot-container:hover #mascot-img { animation: neon-jitter 0.5s infinite linear; }

        /* 滾動條樣式優化 */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; border: 2px solid transparent; background-clip: content-box; }

        /* 載入動畫 */
        .spinner {
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-left-color: #059669;
            border-radius: 50%; width: 2.5rem; height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal 動畫 */
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* 紙張效果 */
        .paper-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 flex flex-col min-h-screen">

    <!-- Header: 現代化漸層風格 -->
    <header class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white shadow-lg relative z-20">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                    <i class="fa-solid fa-book-open text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">易讀轉譯系統<span class="text-xs font-normal opacity-80 bg-emerald-800 px-2 py-0.5 rounded-full ml-1">Beta</span></h1>
                    <p class="text-emerald-100 text-xs tracking-wider">資訊平權 · 溝通無礙</p>
                </div>
            </div>
            <button id="guide-toggle-btn" class="group flex items-center gap-2 bg-emerald-800/50 hover:bg-emerald-800 px-4 py-2 rounded-full transition text-sm font-medium border border-emerald-500/30 backdrop-blur-sm">
                <i class="fa-solid fa-circle-info text-emerald-300 group-hover:text-white transition"></i>
                易讀指南
            </button>
        </div>
    </header>

    <!-- Info Section: 資訊卡片風格 -->
    <div class="bg-white border-b border-gray-200 shadow-sm relative z-10">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row items-center gap-4 bg-orange-50/50 rounded-xl p-3 border border-orange-100">
                <div class="flex items-start gap-4 flex-grow">
                    <!-- ICON: 這裡整合了您的圖示 -->
                    <div class="flex-shrink-0 bg-white p-1.5 rounded-full shadow-sm border border-orange-100 w-12 h-12 flex items-center justify-center">
                        <img src="image/easy-read-icon.png" alt="Easy Read" class="w-full h-auto object-contain" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <i class="fa-solid fa-universal-access text-2xl text-emerald-500 hidden"></i>
                    </div>
                    <div class="text-sm text-gray-600 leading-relaxed">
                        <strong class="text-gray-800 block mb-1">什麼是易讀（Easy Read）？</strong>
                        <p>這是一種將複雜資訊轉化為淺顯易懂內容的格式，旨在協助心智障礙者、高齡者或閱讀困難者獲取資訊，落實 CRPD 資訊近用權。</p>
                    </div>
                </div>
                <a href="https://crpd.sfaa.gov.tw/BulletinCtrl?func=getBulletinList&p=e_1&page=1&rows=15&c=K&t=5&isLocal=N&topic=" target="_blank" 
                   class="flex-shrink-0 whitespace-nowrap flex items-center gap-2 bg-white text-orange-600 hover:text-orange-700 hover:shadow-md px-4 py-2 rounded-lg font-bold transition-all border border-orange-200 text-sm">
                   CRPD 易讀專區 <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Guide Section (Hidden) -->
    <div id="guide-section" class="bg-emerald-50/80 backdrop-blur-md border-b border-emerald-200 hidden transition-all duration-300">
        <div class="max-w-7xl mx-auto p-6 grid md:grid-cols-3 gap-6 text-sm text-emerald-900">
            <div class="bg-white/60 p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-emerald-700"><i class="fa-solid fa-pen-nib"></i> 字與詞</h3>
                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                    <li>使用淺顯易懂的口語詞彙。</li>
                    <li>絕對避免雙重否定句。</li>
                    <li>不使用成語、隱喻、專有名詞。</li>
                    <li>數字請用阿拉伯數字 (1, 2, 3)。</li>
                </ul>
            </div>
            <div class="bg-white/60 p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-emerald-700"><i class="fa-solid fa-align-left"></i> 句子與結構</h3>
                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                    <li><strong>一個概念一行</strong>。</li>
                    <li>使用主動語態 (我吃飯，非飯被我吃)。</li>
                    <li>句子短且清楚。</li>
                    <li>稱呼對方為「你」，自稱為「我」。</li>
                </ul>
            </div>
            <div class="bg-white/60 p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-emerald-700"><i class="fa-regular fa-image"></i> 版面設計</h3>
                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                    <li>字體要大 (建議 16pt 以上)。</li>
                    <li>高對比度 (深色字淺色底)。</li>
                    <li>靠左對齊 (不要左右分散)。</li>
                    <li>適當留白，圖文搭配。</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 grid lg:grid-cols-2 gap-8 w-full flex-grow relative z-0">
        
        <!-- Left: Input Section -->
        <div class="flex flex-col h-full">
            <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 border border-gray-100 flex flex-col h-full overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <label class="text-base font-bold text-gray-700 flex items-center gap-2">
                        <span class="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md">1</span>
                        原始文字輸入
                    </label>
                    <span class="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded">請貼上一般文件</span>
                </div>
                
                <!-- Textarea -->
                <textarea id="user-input" class="w-full flex-grow p-6 focus:outline-none resize-none text-gray-600 leading-relaxed text-base min-h-[250px] placeholder-gray-300" placeholder="請將您想要轉換的複雜文字貼在這裡...&#10;&#10;例如：&#10;「本契約若非經雙方書面同意，不得擅自變更。」&#10;&#10;系統將協助轉換為易讀格式。"></textarea>
                
                <!-- Footer (API & Action) -->
                <div class="bg-gray-50 border-t border-gray-100 p-5 space-y-4">
                     <!-- API Key Input Group -->
                     <div class="relative">
                         <div class="flex justify-between items-end mb-1">
                             <label for="api-key-input" class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Google Gemini API Key</label>
                             <button type="button" id="open-api-modal-btn" class="text-xs text-blue-600 hover:text-blue-800 font-medium hover:underline">
                                 如何取得金鑰？
                             </button>
                         </div>
                         <div class="relative group">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-key text-gray-400 group-focus-within:text-emerald-500 transition"></i>
                             </div>
                             <input type="password" id="api-key-input" autocomplete="off" class="w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition shadow-sm" placeholder="貼上您的 API Key (AIzaSy...)">
                         </div>
                     </div>

                    <button id="convert-btn" class="w-full flex justify-center items-center gap-2 py-3 rounded-xl font-bold text-lg shadow-md transition-all bg-emerald-600 text-white hover:bg-emerald-700 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed">
                        <span id="btn-text">開始 AI 轉譯</span>
                        <i class="fa-solid fa-wand-magic-sparkles" id="btn-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Output Section -->
        <div class="flex flex-col h-full">
            <div class="bg-slate-100 rounded-2xl border border-slate-200 h-full flex flex-col min-h-[400px] relative overflow-hidden">
                 <!-- Header -->
                 <div class="px-6 py-4 border-b border-gray-200/50 bg-white/50 backdrop-blur flex justify-between items-center sticky top-0 z-10">
                    <label class="text-base font-bold text-emerald-800 flex items-center gap-2">
                        <span class="bg-emerald-100 text-emerald-800 w-6 h-6 rounded-full flex items-center justify-center text-xs border border-emerald-200">2</span>
                        易讀版本預覽
                    </label>
                    <button id="copy-btn" class="text-xs font-medium text-slate-500 bg-white hover:bg-emerald-50 hover:text-emerald-600 border border-slate-200 hover:border-emerald-200 px-3 py-1.5 rounded-md transition flex items-center gap-1.5 shadow-sm hidden">
                        <i class="fa-regular fa-copy"></i> 複製內容
                    </button>
                </div>

                <!-- Content Area (Paper Metaphor) -->
                <div class="flex-grow p-6 overflow-y-auto custom-scrollbar relative">
                    
                    <!-- Paper Container -->
                    <div id="result-container" class="min-h-full">
                        
                        <!-- State: Empty -->
                        <div id="state-empty" class="h-full flex flex-col items-center justify-center text-gray-400 py-20">
                            <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4 opacity-50">
                                <i class="fa-solid fa-file-lines text-4xl text-gray-400"></i>
                            </div>
                            <p class="font-medium">等待轉換...</p>
                            <p class="text-sm mt-1 opacity-75">AI 將為您生成大字體、分行清楚的易讀內容</p>
                        </div>

                        <!-- State: Loading -->
                        <div id="state-loading" class="h-full flex flex-col items-center justify-center text-emerald-600 gap-6 py-20 hidden">
                            <div class="spinner"></div>
                            <div class="text-center">
                                <p class="font-bold text-lg animate-pulse">AI 正在思考與改寫</p>
                                <p class="text-sm text-gray-500 mt-2">正在拆解複雜概念...</p>
                            </div>
                        </div>

                        <!-- State: Error -->
                        <div id="state-error" class="h-full flex flex-col items-center justify-center text-red-500 gap-3 py-20 hidden">
                            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center border border-red-100">
                                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                            </div>
                            <p id="error-msg" class="font-medium">發生錯誤</p>
                        </div>

                        <!-- State: Success (The Paper) -->
                        <div id="state-success" class="bg-white p-8 md:p-10 shadow-sm border border-gray-200 mx-auto max-w-2xl min-h-[400px] hidden paper-shadow rounded-sm">
                            <!-- Content injected here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto border-t border-gray-200 bg-white py-6">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-500 text-sm mb-2">此工具由 AI 輔助生成，內容僅供初稿參考，正式發布前請務必進行人工審閱與易讀者測試。</p>
            <p class="text-gray-400 text-xs font-medium">Copyright © Liyuchiutiger Gongminshen</p>
        </div>
    </footer>

    <!-- 吉祥物 -->
    <div id="mascot-container" title="Liyu Chill Guy">
        <img id="mascot-img" src="image/LiyuChillGuy.svg" alt="Liyu Chill Guy" 
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'bg-emerald-600 text-white p-2 rounded-full text-xs text-center border-4 border-white shadow-xl w-20 h-20 flex items-center justify-center cursor-move font-bold transform hover:scale-110 transition\'>Liyu<br>Chill</div>'">
    </div>

    <!-- API Key Modal -->
    <div id="api-modal-overlay" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0" style="opacity: 0; pointer-events: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-0 overflow-hidden transform scale-95 transition-transform" id="api-modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-4 flex justify-between items-center text-white">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fa-brands fa-google"></i>
                    取得 Gemini API 金鑰
                </h3>
                <button id="close-api-modal" class="text-white/80 hover:text-white transition text-2xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                    本系統使用 Google 最新的 Gemini AI 模型進行改寫。您需要自己的免費 API 金鑰才能使用。
                </p>
                
                <ol class="space-y-4">
                    <li class="flex gap-3">
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold border border-blue-200">1</span>
                        <div class="text-sm">
                            前往 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 font-bold hover:underline">Google AI Studio <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a> 並登入。
                        </div>
                    </li>
                    <li class="flex gap-3">
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold border border-blue-200">2</span>
                        <div class="text-sm text-gray-700">
                            點擊 <strong>「Create API key」</strong> 按鈕。
                        </div>
                    </li>
                    <li class="flex gap-3">
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold border border-blue-200">3</span>
                        <div class="text-sm text-gray-700">
                            複製產生的金鑰 (以 <code class="bg-gray-100 px-1 rounded text-red-500">AIza</code> 開頭)，貼回本系統。
                        </div>
                    </li>
                </ol>
                
                <div class="mt-6 bg-yellow-50 border border-yellow-100 p-3 rounded-lg flex gap-3 items-start">
                    <i class="fa-solid fa-shield-halved text-yellow-500 mt-0.5"></i>
                    <p class="text-xs text-yellow-800 leading-tight">
                        <strong>隱私安全：</strong>金鑰僅儲存於您的瀏覽器中，我們不會在伺服器端保存您的金鑰。
                    </p>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end border-t border-gray-100">
                <button id="close-api-modal-btn-bottom" class="bg-white border border-gray-300 text-gray-700 px-6 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition shadow-sm">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 變數與 DOM 元素 ---
        const guideToggleBtn = document.getElementById('guide-toggle-btn');
        const guideSection = document.getElementById('guide-section');
        const userInput = document.getElementById('user-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const convertBtn = document.getElementById('convert-btn');
        const copyBtn = document.getElementById('copy-btn');
        
        // 狀態區塊
        const stateEmpty = document.getElementById('state-empty');
        const stateLoading = document.getElementById('state-loading');
        const stateError = document.getElementById('state-error');
        const stateSuccess = document.getElementById('state-success');
        const errorMsg = document.getElementById('error-msg');

        // Modal 相關
        const openApiModalBtn = document.getElementById('open-api-modal-btn');
        const apiModalOverlay = document.getElementById('api-modal-overlay');
        const apiModalContent = document.getElementById('api-modal-content');
        const closeApiModalX = document.getElementById('close-api-modal');
        const closeApiModalBottom = document.getElementById('close-api-modal-btn-bottom');

        let generatedResultText = "";

        // --- 事件監聽 ---
        
        // 易讀指南開關 (優化動畫)
        guideToggleBtn.addEventListener('click', () => {
            if (guideSection.classList.contains('hidden')) {
                guideSection.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    guideSection.classList.add('opacity-100');
                    guideSection.classList.remove('opacity-0');
                }, 10);
            } else {
                guideSection.classList.add('hidden');
            }
        });

        // 按鈕狀態檢測
        userInput.addEventListener('input', updateBtnState);
        apiKeyInput.addEventListener('input', updateBtnState);

        function updateBtnState() {
            const hasText = userInput.value.trim().length > 0;
            const hasKey = apiKeyInput.value.trim().length > 0;
            convertBtn.disabled = !(hasText && hasKey);
            
            if (!hasKey && hasText) {
                apiKeyInput.parentElement.classList.add('ring-2', 'ring-red-300', 'rounded-lg');
            } else {
                apiKeyInput.parentElement.classList.remove('ring-2', 'ring-red-300', 'rounded-lg');
            }
        }

        // 開始轉換
        convertBtn.addEventListener('click', handleConvert);

        // 複製按鈕
        copyBtn.addEventListener('click', () => {
            if (!generatedResultText) return;
            navigator.clipboard.writeText(generatedResultText).then(() => {
                const originalHtml = copyBtn.innerHTML;
                copyBtn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200');
                copyBtn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-300');
                copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> 已複製';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
                    copyBtn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-300');
                }, 2000);
            }).catch(err => alert('複製失敗'));
        });

        // --- Modal 邏輯 (包含過渡動畫) ---
        function openModal() { 
            apiModalOverlay.classList.remove('hidden');
            // Trigger reflow
            void apiModalOverlay.offsetWidth;
            apiModalOverlay.style.opacity = '1';
            apiModalOverlay.style.pointerEvents = 'auto';
            apiModalContent.classList.remove('scale-95');
            apiModalContent.classList.add('scale-100');
        }
        function closeModal() { 
            apiModalOverlay.style.opacity = '0';
            apiModalOverlay.style.pointerEvents = 'none';
            apiModalContent.classList.remove('scale-100');
            apiModalContent.classList.add('scale-95');
            
            setTimeout(() => {
                apiModalOverlay.classList.add('hidden');
            }, 200);
        }

        openApiModalBtn.addEventListener('click', openModal);
        closeApiModalX.addEventListener('click', closeModal);
        closeApiModalBottom.addEventListener('click', closeModal);
        
        apiModalOverlay.addEventListener('click', (e) => {
            if (e.target === apiModalOverlay) closeModal();
        });

        // --- API 邏輯 ---
        async function handleConvert() {
            const text = userInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!text || !apiKey) {
                alert("請輸入文字並填寫 API Key");
                return;
            }

            // UI 切換至 Loading
            showState('loading');
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<div class="spinner w-5 h-5 border-2"></div> 處理中...';

            const systemPrompt = `
                你是一位專精於「易讀（Easy Read）」資訊轉譯的專家。請根據《臺灣易讀參考指南》的原則，將使用者輸入的文字改寫為易讀版本。

                ### 核心原則（請務必遵守）：
                1. **字詞選擇**：
                - 使用淺顯易懂的口語詞彙，避免艱深字詞。
                - **絕對禁止**使用成語、隱喻、雙重否定句。
                - 避免使用專有名詞，若必須使用，請在該句立刻解釋。
                - 避免使用外來語。
                - 數字請用阿拉伯數字（如 20），不要用國字。
                2. **句子結構**：
                - 句子要短，結構簡單。
                - 使用「主動語態」。
                - 使用「肯定句」優於「否定句」。
                - 避免使用代名詞（他、它），直接稱呼人名或事物名稱。
                3. **排版邏輯（非常重要）**：
                - **一個概念一行**。不要用逗號連結多個概念。
                - 說話對象請用「你」或「我」。
                
                ### 輸出格式：
                請輸出一個 JSON 物件，格式如下：
                {
                    "sections": [
                    { "text": "改寫後的文字第一段，請用 \\n 來換行以呈現一個概念一行" },
                    { "text": "改寫後的文字第二段..." }
                    ]
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    sections: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: { text: { type: "STRING" } }
                                        }
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                   throw new Error("AI 未回傳有效內容，請稍後再試。");
                }

                const jsonContent = JSON.parse(data.candidates[0].content.parts[0].text);
                
                renderResult(jsonContent.sections);
                showState('success');

            } catch (err) {
                console.error(err);
                errorMsg.textContent = err.message || "轉換失敗，請檢查 API Key 或網路連線。";
                showState('error');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerHTML = '<span id="btn-text">開始 AI 轉譯</span><i class="fa-solid fa-wand-magic-sparkles"></i>';
            }
        }

        function renderResult(sections) {
            stateSuccess.innerHTML = '';
            let fullText = [];

            sections.forEach((section, index) => {
                // 保存純文字供複製
                fullText.push(section.text);

                const div = document.createElement('div');
                div.className = 'flex flex-col gap-3 group animate-[fadeIn_0.5s_ease-out] mb-8';
                
                const textDiv = document.createElement('div');
                // 易讀格式：字體加大，行高加大，黑色字
                textDiv.className = 'text-[1.35rem] leading-[1.8] font-medium text-black whitespace-pre-line text-left font-sans';
                textDiv.textContent = section.text;
                
                div.appendChild(textDiv);

                if (index < sections.length - 1) {
                    // 分隔線改為虛線，比較柔和
                    const hr = document.createElement('hr');
                    hr.className = 'border-dashed border-gray-300 my-2';
                    div.appendChild(hr);
                }

                stateSuccess.appendChild(div);
            });

            generatedResultText = fullText.join('\n\n');
            copyBtn.classList.remove('hidden');
        }

        function showState(state) {
            stateEmpty.classList.add('hidden');
            stateLoading.classList.add('hidden');
            stateError.classList.add('hidden');
            stateSuccess.classList.add('hidden');

            if (state === 'loading') {
                stateLoading.classList.remove('hidden');
                copyBtn.classList.add('hidden');
            } else if (state === 'error') {
                stateError.classList.remove('hidden');
                copyBtn.classList.add('hidden');
            } else if (state === 'success') {
                stateSuccess.classList.remove('hidden');
            } else {
                stateEmpty.classList.remove('hidden');
            }
        }

        // --- 吉祥物拖曳邏輯 ---
        const mascot = document.getElementById('mascot-container');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        mascot.addEventListener('mousedown', dragStart);
        mascot.addEventListener('touchstart', dragStart, {passive: false});

        function dragStart(e) {
            isDragging = true;
            
            const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;

            startX = clientX;
            startY = clientY;

            const rect = mascot.getBoundingClientRect();
            initialLeft = rect.left; 
            initialTop = rect.top;

            if(e.cancelable) e.preventDefault();

            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('touchend', dragEnd);
        }

        function dragMove(e) {
            if (!isDragging) return;

            const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;

            const dx = clientX - startX;
            const dy = clientY - startY;

            mascot.style.bottom = 'auto';
            mascot.style.right = 'auto';
            mascot.style.left = `${initialLeft + dx}px`;
            mascot.style.top = `${initialTop + dy}px`;
        }

        function dragEnd() {
            isDragging = false;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('touchend', dragEnd);
        }

    </script>
</body>
</html>